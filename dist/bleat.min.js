/* @license
 *
 * BLE Abstraction Tool: core functionality
 * Version: 0.0.13
 *
 * The MIT License (MIT)
 *
 * Copyright (c) 2015 Rob Moran
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */
!function(a,b){"function"==typeof define&&define.amd?define(b):"object"==typeof exports?module.exports=b():a.bleat=b()}(this,function(){"use strict";function a(a){return function(b){e&&e(a+": "+b)}}function b(a){return function(){if("function"==typeof a){var b=[].slice.call(arguments);a.apply(this,b)}}}var c=null,d={},e=null,f=function(a,b,c){this.address=a,this.name=b,this.connected=!1,this.serviceUUIDs=c,this.services={}};f.prototype.hasService=function(a){var b=!1;return this.serviceUUIDs.some(function(c){return c===a?(b=!0,!0):void 0}),b},f.prototype.connect=function(d,e){c.connect(this,b(d),b(e),a("connect error"))},f.prototype.disconnect=function(){c.disconnect(this,a("disconnect error"))};var g=function(a,b,c){this.uuid=a,this.handle=b,this.primary=c,this.characteristics={}},h=function(a,b,c){this.uuid=a,this.handle=b,this.properties=c,this.descriptors={}};h.prototype.read=function(d){c.readCharacteristic(this,b(d),a("read characteristic error"))},h.prototype.write=function(d,e){c.writeCharacteristic(this,d,b(e),a("write characteristic error"))},h.prototype.enableNotify=function(d,e){c.enableNotify(this,b(d),b(e),a("enable notify error"))},h.prototype.disableNotify=function(d){c.disableNotify(this,b(d),a("disable notify error"))};var i=function(a,b){this.uuid=a,this.handle=b};return i.prototype.read=function(d){c.readDescriptor(this,b(d),a("read descriptor error"))},i.prototype.write=function(d,e){c.writeDescriptor(this,d,b(e),a("write descriptor error"))},{raiseError:function(a){e&&e(a)},addAdapter:function(a,b){d[a]=b,c=b},init:function(f,g,h){e=g,h&&(c=d[h]),c?c.init(b(f),a("init error")):a("init error")("adapter not found")},startScan:function(b){c.stop(a("stop scan error"));var d={};c.scan(function(a){d[a.address]||(d[a.address]=a,b&&b(a))}.bind(this),a("scan error"))},stopScan:function(){c.stop(a("stop scan error"))},asyncWait:function(a,b){var c=0,d=!1;this.addCallback=function(b){return c++,d=!0,function(){b&&b.apply(null,arguments),0==--c&&a&&a()}},this.error=function(){b&&b.apply(null,arguments),0==--c&&a&&a()},this.finish=function(){!d&&a&&a()}},Device:f,Service:g,Characteristic:h,Descriptor:i}}),/* @license
 *
 * BLE Abstraction Tool: chromeos adapter
 * Version: 0.0.6
 *
 * The MIT License (MIT)
 *
 * Copyright (c) 2015 Rob Moran
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */
function(a,b){"function"==typeof define&&define.amd?define(["bleat"],b.bind(this,a)):"object"==typeof exports?module.exports=b(a,require("./bleat.core")):b(a,a.bleat)}(this,function(a,b){"use strict";function c(a,b){return function(){if(chrome.runtime.lastError)return void a(chrome.runtime.lastError.message);if("function"==typeof b){var c=[].slice.call(arguments);b.apply(this,c)}}}a.chrome&&a.chrome.bluetooth&&a.chrome.bluetoothLowEnergy&&b.addAdapter("chromeos",{charNotifies:{},deviceDisconnects:{},foundFn:null,init:function(a,d){chrome.bluetooth.getAdapterState(c(d,function(c){c.available?(chrome.bluetooth.onDeviceAdded.addListener(function(a){if(this.foundFn){var c=new b.Device(a.address,a.name,a.uuids||[]);this.foundFn(c)}}.bind(this)),chrome.bluetoothLowEnergy.onCharacteristicValueChanged.addListener(function(a){"function"==typeof this.charNotifies[a.instanceId]&&(this.charNotifies[a.instanceId](a.value),delete this.charNotifies[a.instanceId])}.bind(this)),chrome.bluetooth.onDeviceRemoved.addListener(this.checkDisconnect.bind(this)),chrome.bluetooth.onDeviceChanged.addListener(function(a){a.connected===!1&&this.checkDisconnect(a)}.bind(this)),a()):d("adapter not enabled")}.bind(this)))},checkDisconnect:function(a){"function"==typeof this.deviceDisconnects[a.address]&&(this.deviceDisconnects[a.address](),delete this.deviceDisconnects[a.address])},scan:function(a,d){chrome.bluetooth.getDevices(c(d,function(c){c.forEach(function(c){var d=new b.Device(c.address,c.name,c.uuids||[]);a(d)})})),this.foundFn=a,chrome.bluetooth.startDiscovery(c(d))},stop:function(a){this.foundFn=null,chrome.bluetooth.discovering&&chrome.bluetooth.stopDiscovery(c(a))},connect:function(a,d,e,f){chrome.bluetoothLowEnergy.connect(a.address,c(f,function(){this.deviceDisconnects[a.address]=function(){a.connected=!1,a.services={},e()},a.connected=!0,chrome.bluetoothLowEnergy.getServices(a.address,c(f,function(e){e.forEach(function(d){var e=new b.Service(d.uuid,d.instanceId,d.isPrimary);a.services[e.uuid]=e,chrome.bluetoothLowEnergy.getCharacteristics(d.instanceId,c(f,function(a){a.forEach(function(a){var d=new b.Characteristic(a.uuid,a.instanceId,a.properties);e.characteristics[d.uuid]=d,chrome.bluetoothLowEnergy.getDescriptors(a.instanceId,c(f,function(a){a.forEach(function(a){var c=new b.Descriptor(a.uuid,a.instanceId);d.descriptors[c.uuid]=c})}))})}))}),setTimeout(d,0)}))}.bind(this)))},disconnect:function(a,b){chrome.bluetoothLowEnergy.disconnect(a.address,c(b))},readCharacteristic:function(a,b,d){chrome.bluetoothLowEnergy.readCharacteristicValue(a.handle,c(d,function(a){b(a.value)}))},writeCharacteristic:function(a,b,d,e){chrome.bluetoothLowEnergy.writeCharacteristicValue(a.handle,b.buffer,c(e,d))},enableNotify:function(a,b,d,e){chrome.bluetoothLowEnergy.startCharacteristicNotifications(a.handle,null,c(e,function(){this.charNotifies[a.handle]=b,d()}.bind(this)))},disableNotify:function(a,b,d){chrome.bluetoothLowEnergy.stopCharacteristicNotifications(a.handle,c(d,function(){this.charNotifies[a.handle]&&delete this.charNotifies[a.handle],b()}.bind(this)))},readDescriptor:function(a,b,d){chrome.bluetoothLowEnergy.readDescriptorValue(a.handle,c(d,function(a){b(a.value)}))},writeDescriptor:function(a,b,d,e){chrome.bluetoothLowEnergy.writeDescriptorValue(a.handle,b.buffer,c(e,d))}})}),/* @license
 *
 * BLE Abstraction Tool: evothings adapter
 * Version: 0.0.6
 *
 * The MIT License (MIT)
 *
 * Copyright (c) 2015 Rob Moran
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */
function(a,b){"function"==typeof define&&define.amd?define(["bleat"],b.bind(this,a)):"object"==typeof exports?module.exports=b(a,require("./bleat.core")):b(a,a.bleat)}(this,function(a,b){"use strict";function c(a){return a>64&&91>a?a-65:a>96&&123>a?a-71:a>47&&58>a?a+4:43===a?62:47===a?63:0}function d(a,b){for(var d,e,f=a.replace(/[^A-Za-z0-9\+\/]/g,""),g=f.length,h=b?Math.ceil((3*g+1>>2)/b)*b:3*g+1>>2,i=new Uint8Array(h),j=0,k=0,l=0;g>l;l++)if(e=3&l,j|=c(f.charCodeAt(l))<<18-6*e,3===e||g-l===1){for(d=0;3>d&&h>k;d++,k++)i[k]=j>>>(16>>>d&24)&255;j=0}return i}function e(a,b){return(a[b+1]<<8)+a[b]}function f(a,b){return(a[b+3]<<24)+(a[b+2]<<16)+(a[b+1]<<8)+a[b]}function g(a,b){var c="",d=0;return[4,2,2,2,6].forEach(function(e){c+="-";for(var f=0;e>f;f++,d++)c+=("00"+a[b+d].toString(16)).slice(-2)}),c.substr(1)}function h(a){var b={name:a.name,serviceUUIDs:[]};if(a.advertisementData)a.advertisementData.kCBAdvDataLocalName&&(b.name=a.advertisementData.kCBAdvDataLocalName),a.advertisementData.kCBAdvDataServiceUUIDs&&a.advertisementData.kCBAdvDataServiceUUIDs.forEach(function(a){a.length>8?b.serviceUUIDs.push(a.toLowerCase()):b.serviceUUIDs.push(("00000000"+a.toLowerCase()).slice(-8)+i)});else if(a.scanRecord)for(var c=d(a.scanRecord),h=0;h<c.length;){var j=c[h++];if(0===j)break;j-=1;var k,l=c[h++];if(2==l||3==l)for(k=0;j>k;k+=2)b.serviceUUIDs.push(("0000"+e(c,h+k).toString(16)).slice(-8)+i);else if(4==l||5==l)for(k=0;j>k;k+=4)b.serviceUUIDs.push(("00000000"+f(c,h+k).toString(16)).slice(-8)+i);else if(6==l||7==l)for(k=0;j>k;k+=4)b.serviceUUIDs.push(g(c,h+k));else(8==l||9==l)&&(b.name=evothings.ble.fromUtf8(new Uint8Array(c.buffer,h,j)).replace("\x00",""));h+=j}return b}var i="-0000-1000-8000-00805f9b34fb",j="00002902-0000-1000-8000-00805f9b34fb";if(a.cordova){var k=a.cordova.platformId;b.addAdapter("evothings",{deviceHandles:{},characteristicHandles:{},descriptorHandles:{},notifyCallbacks:{},init:function(b,c){a.evothings&&evothings.ble?b():document.addEventListener("deviceready",b)},scan:function(a,c){evothings.ble.startScan(function(c){var d=h(c),e=new b.Device(c.address,d.name,d.serviceUUIDs);a(e)},c)},stop:function(a){evothings.ble.stopScan()},connect:function(a,c,d,e){evothings.ble.connect(a.address,function(f){0===f.state?(a.connected=!1,a.services={},this.deviceHandles[a.address]&&(evothings.ble.close(this.deviceHandles[a.address]),delete this.deviceHandles[a.address]),d()):2===f.state&&(a.connected=!0,this.deviceHandles[a.address]=f.deviceHandle,evothings.ble.readAllServiceData(f.deviceHandle,function(d){d.forEach(function(c){var d=new b.Service(c.uuid,c.handle,0===c.type);a.services[d.uuid]=d,c.characteristics.forEach(function(a){var c=[],e=new b.Characteristic(a.uuid,a.handle,c);d.characteristics[e.uuid]=e,this.characteristicHandles[a.handle]=f.deviceHandle,a.descriptors.forEach(function(a){var c=new b.Descriptor(a.uuid,a.handle);e.descriptors[c.uuid]=c,this.descriptorHandles[a.handle]=f.deviceHandle},this)},this)},this),c()}.bind(this),e))}.bind(this),e)},disconnect:function(a,b){this.deviceHandles[a.address]&&evothings.ble.close(this.deviceHandles[a.address])},readCharacteristic:function(a,b,c){evothings.ble.readCharacteristic(this.characteristicHandles[a.handle],a.handle,function(d){"ios"===k&&this.notifyCallbacks[a.uuid]&&this.enableNotify(a,this.notifyCallbacks[a.uuid],null,c),b(d)}.bind(this),c)},writeCharacteristic:function(a,b,c,d){evothings.ble.writeCharacteristic(this.characteristicHandles[a.handle],a.handle,b,c,d)},enableNotify:function(a,b,c,d){var e=function(){evothings.ble.enableNotification(this.characteristicHandles[a.handle],a.handle,b,d),"ios"===k&&(this.notifyCallbacks[a.uuid]=b),c&&c()};if("android"===k){var f=a.descriptors[j];if(!f)return void d("cannot find notify descriptor");this.writeDescriptor(f,new Uint8Array([1,0]),e.bind(this),d)}else e.call(this)},disableNotify:function(a,b,c){evothings.ble.disableNotification(this.characteristicHandles[a.handle],a.handle,b,c),"ios"===k&&(delete this.notifyCallbacks[a.uuid],b())},readDescriptor:function(a,b,c){evothings.ble.readDescriptor(this.descriptorHandles[a.handle],a.handle,b,c)},writeDescriptor:function(a,b,c,d){evothings.ble.writeDescriptor(this.descriptorHandles[a.handle],a.handle,b,c,d)}})}}),/* @license
 *
 * BLE Abstraction Tool: noble adapter
 * Version: 0.0.2
 *
 * The MIT License (MIT)
 *
 * Copyright (c) 2015 Rob Moran
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */
function(a,b){"function"==typeof define&&define.amd?define(["noble","bleat"],b):"object"==typeof exports?module.exports=b(require("noble"),require("./bleat.core")):b(a.noble,a.bleat)}(this,function(a,b){"use strict";function c(a,b){return function(c){if(c)a(c);else if("function"==typeof b){var d=[].slice.call(arguments,1);b.apply(this,d)}}}function d(a){var b="-0000-1000-8000-00805f9b34fb";return a.length>8?a.toLowerCase():("00000000"+a.toLowerCase()).slice(-8)+b}a&&b.addAdapter("noble",{foundFn:null,deviceHandles:{},characteristicHandles:{},descriptorHandles:{},charNotifies:{},init:function(c,e){function f(f){"poweredOn"===f?(a.on("discover",function(a){if(this.foundFn){var c=a.address&&"unknown"!==a.address?a.address:a.uuid;this.deviceHandles[c]=a;var e=[];a.advertisement.serviceUuids.forEach(function(a){e.push(d(a))});var f=new b.Device(c,a.advertisement.localName||c,e);this.foundFn(f)}}.bind(this)),c()):e("adapter not enabled")}"unknown"===a.state?a.once("stateChange",f.bind(this)):f(a.state)},scan:function(b,d){this.foundFn=b,a.startScanning([],!1,c(d))},stop:function(b){a.stopScanning()},connect:function(a,e,f,g){var h=this.deviceHandles[a.address],i=new b.asyncWait(function(){a.connected=!0,e()});h.once("connect",function(){h.discoverServices([],c(g,function(e){e.forEach(function(e){var f=d(e.uuid),h=new b.Service(f,f,!1);a.services[h.uuid]=h,e.discoverCharacteristics([],i.addCallback(c(g,function(a){a.forEach(function(a){var e=d(a.uuid),f=new b.Characteristic(e,e,a.properties);h.characteristics[f.uuid]=f,this.characteristicHandles[a.uuid]=a,a.on("read",function(a,b){if(b===!0&&"function"==typeof this.charNotifies[e]){var c=new Uint8Array(a).buffer;this.charNotifies[e](c)}}.bind(this)),a.discoverDescriptors(i.addCallback(c(g,function(c){c.forEach(function(c){var e=d(c.uuid),g=a.uuid+"-"+c.uuid,h=new b.Descriptor(e,g);f.descriptors[e]=h,this.descriptorHandles[g]=c},this)}.bind(this))))},this)}.bind(this)))),i.finish()},this)}.bind(this)))}.bind(this)),h.once("disconnect",function(){a.connected=!1,f()}.bind(this)),h.connect(c(g))},disconnect:function(a,b){this.deviceHandles[a.address].disconnect(c(b))},readCharacteristic:function(a,b,d){this.characteristicHandles[a.handle].read(c(d,function(a){var c=new Uint8Array(a).buffer;b(c)}))},writeCharacteristic:function(a,b,d,e){var f=new Buffer(new Uint8Array(b.buffer));this.characteristicHandles[a.handle].write(f,!0,c(e,d))},enableNotify:function(a,b,d,e){this.characteristicHandles[a.handle].once("notify",function(c){return c!==!0?e("notify failed to enable"):(this.charNotifies[a.uuid]=b,void d())}.bind(this)),this.characteristicHandles[a.handle].notify(!0,c(e))},disableNotify:function(a,b,d){this.characteristicHandles[a.handle].once("notify",function(c){return c!==!1?d("notify failed to disable"):(this.charNotifies[a.uuid]&&delete this.charNotifies[a.uuid],void b())}.bind(this)),this.characteristicHandles[a.handle].notify(!1,c(d))},readDescriptor:function(a,b,d){this.descriptorHandles[a.handle].readValue(c(d,function(a){var c=new Uint8Array(a).buffer;b(c)}))},writeDescriptor:function(a,b,d,e){var f=new Buffer(new Uint8Array(b.buffer));this.descriptorHandles[a.handle].writeValue(f,c(e,d))}})});