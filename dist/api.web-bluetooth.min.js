/* @license
 *
 * BLE Abstraction Tool: bluetooth helpers
 * Version: 0.0.1
 *
 * The MIT License (MIT)
 *
 * Copyright (c) 2016 Rob Moran
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */
!function(a,b){"function"==typeof define&&define.amd?define(b):"object"==typeof exports?module.exports=b():a.bleatHelpers=b()}(this,function(){"use strict";function a(a){return"number"==typeof a&&(a=a.toString(16)),a=a.toLowerCase(),a.length<=8&&(a=("00000000"+a).slice(-8)+"-0000-1000-8000-00805f9b34fb"),32===a.length&&(a=a.match(/^([0-9a-f]{8})([0-9a-f]{4})([0-9a-f]{4})([0-9a-f]{4})([0-9a-f]{12})$/).splice(1).join("-")),a}function b(b){return e[b]&&(b=e[b]),a(b)}function c(b){return f[b]&&(b=f[b]),a(b)}function d(b){return g[b]&&(b=g[b]),a(b)}var e={alert_notification:6161,automation_io:6165,battery_service:6159,blood_pressure:6160,body_composition:6171,bond_management:6174,continuous_glucose_monitoring:6175,current_time:6149,cycling_power:6168,cycling_speed_and_cadence:6166,device_information:6154,environmental_sensing:6170,generic_access:6144,generic_attribute:6145,glucose:6152,health_thermometer:6153,heart_rate:6157,human_interface_device:6162,immediate_alert:6146,indoor_positioning:6177,internet_protocol_support:6176,link_loss:6147,location_and_navigation:6169,next_dst_change:6151,phone_alert_status:6158,pulse_oximeter:6178,reference_time_update:6150,running_speed_and_cadence:6164,scan_parameters:6163,tx_power:6148,user_data:6172,weight_scale:6173},f={aerobic_heart_rate_lower_limit:10878,aerobic_heart_rate_upper_limit:10884,aerobic_threshold:10879,age:10880,aggregate:10842,alert_category_id:10819,alert_category_id_bit_mask:10818,alert_level:10758,alert_notification_control_point:10820,alert_status:10815,altitude:10931,anaerobic_heart_rate_lower_limit:10881,anaerobic_heart_rate_upper_limit:10882,anaerobic_threshold:10883,analog:10840,apparent_wind_direction:10867,apparent_wind_speed:10866,"gap.appearance":10753,barometric_pressure_trend:10915,battery_level:10777,blood_pressure_feature:10825,blood_pressure_measurement:10805,body_composition_feature:10907,body_composition_measurement:10908,body_sensor_location:10808,bond_management_control_point:10916,bond_management_feature:10917,boot_keyboard_input_report:10786,boot_keyboard_output_report:10802,boot_mouse_input_report:10803,"gap.central_address_resolution_support":10918,cgm_feature:10920,cgm_measurement:10919,cgm_session_run_time:10923,cgm_session_start_time:10922,cgm_specific_ops_control_point:10924,cgm_status:10921,csc_feature:10844,csc_measurement:10843,current_time:10795,cycling_power_control_point:10854,cycling_power_feature:10853,cycling_power_measurement:10851,cycling_power_vector:10852,database_change_increment:10905,date_of_birth:10885,date_of_threshold_assessment:10886,date_time:10760,day_date_time:10762,day_of_week:10761,descriptor_value_changed:10877,"gap.device_name":10752,dew_point:10875,digital:10838,dst_offset:10765,elevation:10860,email_address:10887,exact_time_256:10764,fat_burn_heart_rate_lower_limit:10888,fat_burn_heart_rate_upper_limit:10889,firmware_revision_string:10790,first_name:10890,five_zone_heart_rate_limits:10891,floor_number:10930,gender:10892,glucose_feature:10833,glucose_measurement:10776,glucose_measurement_context:10804,gust_factor:10868,hardware_revision_string:10791,heart_rate_control_point:10809,heart_rate_max:10893,heart_rate_measurement:10807,heat_index:10874,height:10894,hid_control_point:10828,hid_information:10826,hip_circumference:10895,humidity:10863,"ieee_11073-20601_regulatory_certification_data_list":10794,indoor_positioning_configuration:10925,intermediate_blood_pressure:10806,intermediate_temperature:10782,irradiance:10871,language:10914,last_name:10896,latitude:10926,ln_control_point:10859,ln_feature:10858,"local_east_coordinate.xml":10929,local_north_coordinate:10928,local_time_information:10767,location_and_speed:10855,location_name:10933,longitude:10927,magnetic_declination:10796,magnetic_flux_density_2D:10912,magnetic_flux_density_3D:10913,manufacturer_name_string:10793,maximum_recommended_heart_rate:10897,measurement_interval:10785,model_number_string:10788,navigation:10856,new_alert:10822,"gap.peripheral_preferred_connection_parameters":10756,"gap.peripheral_privacy_flag":10754,plx_continuous_measurement:10847,plx_features:10848,plx_spot_check_measurement:10846,pnp_id:10832,pollen_concentration:10869,position_quality:10857,pressure:10861,protocol_mode:10830,rainfall:10872,"gap.reconnection_address":10755,record_access_control_point:10834,reference_time_information:10772,report:10829,report_map:10827,resting_heart_rate:10898,ringer_control_point:10816,ringer_setting:10817,rsc_feature:10836,rsc_measurement:10835,sc_control_point:10837,scan_interval_window:10831,scan_refresh:10801,sensor_location:10845,serial_number_string:10789,"gatt.service_changed":10757,software_revision_string:10792,sport_type_for_aerobic_and_anaerobic_thresholds:10899,supported_new_alert_category:10823,supported_unread_alert_category:10824,system_id:10787,temperature:10862,temperature_measurement:10780,temperature_type:10781,three_zone_heart_rate_limits:10900,time_accuracy:10770,time_source:10771,time_update_control_point:10774,time_update_state:10775,time_with_dst:10769,time_zone:10766,true_wind_direction:10865,true_wind_speed:10864,two_zone_heart_rate_limit:10901,tx_power_level:10759,uncertainty:10932,unread_alert_status:10821,user_control_point:10911,user_index:10906,uv_index:10870,vo2_max:10902,waist_circumference:10903,weight:10904,weight_measurement:10909,weight_scale_feature:10910,wind_chill:10873},g={"gatt.characteristic_extended_properties":10496,"gatt.characteristic_user_description":10497,"gatt.client_characteristic_configuration":10498,"gatt.server_characteristic_configuration":10499,"gatt.characteristic_presentation_format":10500,"gatt.characteristic_aggregate_format":10501,valid_range:10502,external_report_reference:10503,report_reference:10504,number_of_digitals:10505,value_trigger_setting:10506,es_configuration:10507,es_measurement:10508,es_trigger_setting:10509,time_trigger_setting:10510};return{Services:e,Characteristics:f,Descriptors:g,getCanonicalUUID:a,getServiceUUID:b,getCharacteristicUUID:c,getDescriptorUUID:d}}),/* @license
 *
 * BLE Abstraction Tool: core functionality - web bluetooth specification
 * Version: 0.0.17
 *
 * The MIT License (MIT)
 *
 * Copyright (c) 2016 Rob Moran
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */
function(a,b){"function"==typeof define&&define.amd?a.navigator.bluetooth?define(a.navigator.bluetooth):define(["es6-promise","es6-map","bluetooth.helpers"],b):"object"==typeof exports?module.exports=b(Promise,Map,require("./bluetooth.helpers")):a.bleat=a.navigator.bluetooth||b(a.Promise,a.Map,a.bleatHelpers)}(this,function(a,b,c){"use strict";function d(a,b){return function(c){a(b+": "+c)}}function e(a,b){b&&Object.keys(b).forEach(function(c){b[c]&&a.hasOwnProperty(c)&&("[object Object]"===Object.prototype.toString.call(a[c])?e(a[c],b[c]):"[object Map]"===Object.prototype.toString.call(a[c])&&"[object Object]"===Object.prototype.toString.call(b[c])?Object.keys(b[c]).forEach(function(d){a[c].set(d,b[c][d])}):a[c]=b[c])})}function f(a,b,d,e){var f=[];a.filters&&a.filters.forEach(function(a){a.services&&(f=f.concat(a.services.map(c.getServiceUUID)))}),f=f.filter(function(a,b,c){return c.indexOf(a)===b});var g,h=a.scanTime||j;k.startScan(f,function(a){b(a,g)},function(){g=setTimeout(function(){k.stopScan(),d()},h)},e)}function g(a){return function(b,c,d){a.indexOf(b)<0||(m[this]||(m[this]={}),m[this][b]||(m[this][b]=[]),m[this][b].push(c))}}function h(a,b,c){if(m[this]&&m[this][a]){var d=m[this][a].indexOf(b);d>=0&&m[this][a].splice(d,1),0===m[this][a].length&&delete m[this][a],0===Object.keys(m[this]).length&&delete m[this]}}function i(a){m[this]&&m[this][a.type]&&(a.target=this,m[this][a.type].forEach(function(b){"function"==typeof b&&b(a)}))}var j=10240,k=null,l={},m={},n=function(a){this._handle=null,this.id="unknown",this.name=null,this.adData={appearance:null,txPower:null,rssi:null,manufacturerData:new b,serviceData:new b},this.deviceClass=null,this.vendorIDSource="bluetooth",this.vendorID=null,this.productID=null,this.productVersion=null,this.gatt=new o,this.gatt.device=this,this.uuids=[],e(this,a)};n.prototype.addEventListener=g(["gattserverdisconnected"]),n.prototype.removeEventListener=h,n.prototype.dispatchEvent=i;var o=function(){this._services=null,this.device=null,this.connected=!1};o.prototype.connect=function(){return new a(function(a,b){k.connect(this.device._handle,function(){this.connected=!0,a(this)}.bind(this),function(){this.connected=!1,this.device.dispatchEvent({type:"gattserverdisconnected",bubbles:!0})}.bind(this),d(b,"connect error"))}.bind(this))},o.prototype.disconnect=function(){k.disconnect(this.device._handle),this.connected=!1},o.prototype.getPrimaryService=function(b){return new a(function(a,c){return b?void this.getPrimaryServices(b).then(function(b){return 1!==b.length?c("getPrimaryService error: service not found"):void a(b[0])})["catch"](function(a){c(a)}):c("getPrimaryService error: no service specified")}.bind(this))},o.prototype.getPrimaryServices=function(b){return new a(function(a,e){function f(){if(!b)return a(this._services);var d=this._services.filter(function(a){return a.uuid===c.getServiceUUID(b)});return 1!==d.length?e("getPrimaryServices error: service not found"):void a(d)}return this._services?f.call(this):void k.discoverServices(this.device._handle,[],function(a){this._services=a.map(function(a){return a.device=this.device,new p(a)}.bind(this)),f.call(this)}.bind(this),d(e,"getPrimaryServices error"))}.bind(this))};var p=function(a){this._handle=null,this._services=null,this._characteristics=null,this.device=null,this.uuid=null,this.isPrimary=!1,e(this,a),this.dispatchEvent({type:"serviceadded",bubbles:!0})};p.prototype.getCharacteristic=function(b){return new a(function(a,c){return b?void this.getCharacteristics(b).then(function(b){return 1!==b.length?c("getCharacteristic error: characteristic not found"):void a(b[0])})["catch"](function(a){c(a)}):c("getCharacteristic error: no characteristic specified")}.bind(this))},p.prototype.getCharacteristics=function(b){return new a(function(a,e){function f(){if(!b)return a(this._characteristics);var d=this._characteristics.filter(function(a){return a.uuid===c.getCharacteristicUUID(b)});return 1!==d.length?e("getCharacteristics error: characteristic not found"):void a(d)}return this._characteristics?f.call(this):void k.discoverCharacteristics(this._handle,[],function(a){this._characteristics=a.map(function(a){return a.service=this,new q(a)}.bind(this)),f.call(this)}.bind(this),d(e,"getCharacteristics error"))}.bind(this))},p.prototype.getIncludedService=function(b){return new a(function(a,c){return b?void this.getIncludedServices(b).then(function(b){return 1!==b.length?c("getIncludedService error: service not found"):void a(b[0])})["catch"](function(a){c(a)}):c("getIncludedService error: no service specified")}.bind(this))},p.prototype.getIncludedServices=function(b){return new a(function(a,e){function f(){if(!b)return a(this._services);var d=this._services.filter(function(a){return a.uuid===c.getServiceUUID(b)});return 1!==d.length?e("getIncludedServices error: service not found"):void a(d)}return this._services?f.call(this):void k.discoverIncludedServices(this._handle,[],function(a){this._services=a.map(function(a){return a.device=this.device,new p(a)}.bind(this)),f.call(this)}.bind(this),d(e,"getIncludedServices error"))}.bind(this))},p.prototype.addEventListener=g(["serviceadded","servicechanged","serviceremoved"]),p.prototype.removeEventListener=h,p.prototype.dispatchEvent=i;var q=function(a){this._handle=null,this._descriptors=null,this.service=null,this.uuid=null,this.properties={broadcast:!1,read:!1,writeWithoutResponse:!1,write:!1,notify:!1,indicate:!1,authenticatedSignedWrites:!1,reliableWrite:!1,writableAuxiliaries:!1},this.value=null,e(this,a)};q.prototype.getDescriptor=function(b){return new a(function(a,c){return b?void this.getDescriptors(b).then(function(b){return 1!==b.length?c("getDescriptor error: descriptor not found"):void a(b[0])})["catch"](function(a){c(a)}):c("getDescriptor error: no descriptor specified")}.bind(this))},q.prototype.getDescriptors=function(b){return new a(function(a,e){function f(){if(!b)return a(this._descriptors);var d=this._descriptors.filter(function(a){return a.uuid===c.getDescriptorUUID(b)});return 1!==d.length?e("getDescriptors error: descriptor not found"):void a(d)}return this._descriptors?f.call(this):void k.discoverDescriptors(this._handle,[],function(a){this._descriptors=a.map(function(a){return a.characteristic=this,new r(a)}.bind(this)),f.call(this)}.bind(this),d(e,"getDescriptors error"))}.bind(this))},q.prototype.readValue=function(){return new a(function(a,b){k.readCharacteristic(this._handle,function(b){this.value=b,a(b),this.dispatchEvent({type:"characteristicvaluechanged",bubbles:!0})}.bind(this),d(b,"readValue error"))}.bind(this))},q.prototype.writeValue=function(b){var c=b.buffer||b,e=new DataView(c);return new a(function(a,b){k.writeCharacteristic(this._handle,e,function(){this.value=e,a()}.bind(this),d(b,"writeValue error"))}.bind(this))},q.prototype.startNotifications=function(){return new a(function(a,b){k.enableNotify(this._handle,function(a){this.value=a,this.dispatchEvent({type:"characteristicvaluechanged",bubbles:!0})}.bind(this),a,d(b,"startNotifications error"))}.bind(this))},q.prototype.stopNotifications=function(){return new a(function(a,b){k.disableNotify(this._handle,a,d(b,"stopNotifications error"))}.bind(this))},q.prototype.addEventListener=g(["characteristicvaluechanged"]),q.prototype.removeEventListener=h,q.prototype.dispatchEvent=i;var r=function(a){this._handle=null,this.characteristic=null,this.uuid=null,this.value=null,e(this,a)};return r.prototype.readValue=function(){return new a(function(a,b){k.readDescriptor(this._handle,function(b){this.value=b,a(b)}.bind(this),d(b,"readValue error"))}.bind(this))},r.prototype.writeValue=function(b){var c=b.buffer||b,e=new DataView(c);return new a(function(a,b){k.writeDescriptor(this._handle,e,function(){this.value=e,a()}.bind(this),d(b,"writeValue error"))}.bind(this))},{_addAdapter:function(a,b){l[a]=b,k=b},requestDevice:function(b){return new a(function(a,c){f(b,function(b,c){c&&clearTimeout(c),k.stopScan(),a(new n(b))},function(){c("requestDevice error: no devices found")},d(c,"requestDevice error"))})},requestDevices:function(b){return new a(function(a,c){var e=[];f(b,function(a){e.push(a)},function(){0===e.length?c("requestDevices error: no devices found"):a(e.map(function(a){return new n(a)}))},d(c,"requestDevices error"))})}}}),/* @license
 *
 * BLE Abstraction Tool: chromeos adapter
 * Version: 0.0.8
 *
 * The MIT License (MIT)
 *
 * Copyright (c) 2015 Rob Moran
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */
function(a,b){"function"==typeof define&&define.amd?define(["bleat"],b.bind(this,a.chrome)):"object"==typeof exports?module.exports=function(c){return b(a.chrome,c)}:b(a.chrome,a.bleat)}(this,function(a,b){"use strict";function c(b,c){return function(){if(a.runtime.lastError)return void b(a.runtime.lastError.message);if("function"==typeof c){var d=[].slice.call(arguments);c.apply(this,d)}}}a&&a.bluetooth&&a.bluetoothLowEnergy&&b._addAdapter("chromeos",{charNotifies:{},deviceDisconnects:{},deviceFoundFn:function(){},init:function(b,d){a.bluetooth.getAdapterState(c(d,function(c){c.available?(a.bluetooth.onDeviceAdded.addListener(this.deviceFoundFn),a.bluetoothLowEnergy.onCharacteristicValueChanged.addListener(function(a){"function"==typeof this.charNotifies[a.instanceId]&&(this.charNotifies[a.instanceId](a.value),delete this.charNotifies[a.instanceId])}.bind(this)),a.bluetooth.onDeviceRemoved.addListener(this.checkDisconnect.bind(this)),a.bluetooth.onDeviceChanged.addListener(function(a){a.connected===!1&&this.checkDisconnect(a)}.bind(this)),b()):d("adapter not enabled")}.bind(this)))},checkDisconnect:function(a){"function"==typeof this.deviceDisconnects[a.address]&&(this.deviceDisconnects[a.address](),delete this.deviceDisconnects[a.address])},startScan:function(d,e,f){this.deviceFoundFn=function(a){var c=0===d.length||d.some(function(b){return a.uuids.indexOf(b)>=0});if(c){var f=new b._Device(a.address,a.name,a.uuids||[]);e(f)}},a.bluetooth.getDevices(c(f,function(a){a.forEach(this.deviceFoundFn)})),a.bluetooth.stopDiscovery(function(){a.runtime.lastError;a.bluetooth.startDiscovery(c(f))})},stopScan:function(b){this.deviceFoundFn=function(){},a.bluetooth.stopDiscovery(function(){a.runtime.lastError})},connect:function(b,d,e,f){a.bluetoothLowEnergy.connect(b.address,c(f,function(){this.deviceDisconnects[b.address]=e,d()}.bind(this)))},disconnect:function(b,d){a.bluetoothLowEnergy.disconnect(b.address,c(d))},discoverServices:function(d,e,f,g){a.bluetoothLowEnergy.getServices(d.address,c(g,function(a){a.forEach(function(a){if(0===e.length||e.indexOf(a.uuid)>=0){var c=new b._Service(a.instanceId,a.uuid,a.isPrimary);d.services[c.uuid]=c}}),f()}))},discoverIncludedServices:function(d,e,f,g){a.bluetoothLowEnergy.getIncludedServices(d._handle,c(g,function(a){a.forEach(function(a){if(0===e.length||e.indexOf(a.uuid)>=0){var c=new b._Service(a.instanceId,a.uuid,a.isPrimary);c.includedServices[c.uuid]=c}}),f()}))},discoverCharacteristics:function(d,e,f,g){a.bluetoothLowEnergy.getCharacteristics(d._handle,c(g,function(a){a.forEach(function(a){if(0===e.length||e.indexOf(a.uuid)>=0){var c=new b._Characteristic(a.instanceId,a.uuid,a.properties);d.characteristics[c.uuid]=c}}),f()}))},discoverDescriptors:function(d,e,f,g){a.bluetoothLowEnergy.getDescriptors(d._handle,c(g,function(a){a.forEach(function(a){if(0===e.length||e.indexOf(a.uuid)>=0){var c=new b._Descriptor(a.instanceId,a.uuid);d.descriptors[c.uuid]=c}}),f()}))},readCharacteristic:function(b,d,e){a.bluetoothLowEnergy.readCharacteristicValue(b.handle,c(e,function(a){d(a.value)}))},writeCharacteristic:function(b,d,e,f){a.bluetoothLowEnergy.writeCharacteristicValue(b.handle,d.buffer,c(f,e))},enableNotify:function(b,d,e,f){a.bluetoothLowEnergy.startCharacteristicNotifications(b.handle,null,c(f,function(){this.charNotifies[b.handle]=d,e()}.bind(this)))},disableNotify:function(b,d,e){a.bluetoothLowEnergy.stopCharacteristicNotifications(b.handle,c(e,function(){this.charNotifies[b.handle]&&delete this.charNotifies[b.handle],d()}.bind(this)))},readDescriptor:function(b,d,e){a.bluetoothLowEnergy.readDescriptorValue(b.handle,c(e,function(a){d(a.value)}))},writeDescriptor:function(b,d,e,f){a.bluetoothLowEnergy.writeDescriptorValue(b.handle,d.buffer,c(f,e))}})}),/* @license
 *
 * BLE Abstraction Tool: evothings adapter
 * Version: 0.0.8
 *
 * The MIT License (MIT)
 *
 * Copyright (c) 2015 Rob Moran
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */
function(a,b){"function"==typeof define&&define.amd?define(["bleat"],b.bind(this,a,a.cordova)):"object"==typeof exports?module.exports=function(c){return b(a,a.cordova,c)}:b(a,a.cordova,a.bleat)}(this,function(a,b,c){"use strict";function d(a){return a>64&&91>a?a-65:a>96&&123>a?a-71:a>47&&58>a?a+4:43===a?62:47===a?63:0}function e(a,b){for(var c,e,f=a.replace(/[^A-Za-z0-9\+\/]/g,""),g=f.length,h=b?Math.ceil((3*g+1>>2)/b)*b:3*g+1>>2,i=new Uint8Array(h),j=0,k=0,l=0;g>l;l++)if(e=3&l,j|=d(f.charCodeAt(l))<<18-6*e,3===e||g-l===1){for(c=0;3>c&&h>k;c++,k++)i[k]=j>>>(16>>>c&24)&255;j=0}return i}function f(a,b){return(a[b+1]<<8)+a[b]}function g(a,b){return(a[b+3]<<24)+(a[b+2]<<16)+(a[b+1]<<8)+a[b]}function h(a,b){for(var c="",d=0;16>d;d++)c+=("00"+a[b+d].toString(16)).slice(-2);return c}function i(a){var b={name:a.name,serviceUUIDs:[]};if(a.advertisementData)a.advertisementData.kCBAdvDataLocalName&&(b.name=a.advertisementData.kCBAdvDataLocalName),a.advertisementData.kCBAdvDataServiceUUIDs&&a.advertisementData.kCBAdvDataServiceUUIDs.forEach(function(a){b.serviceUUIDs.push(c._canonicalUUID(a))});else if(a.scanRecord)for(var d=e(a.scanRecord),i=0;i<d.length;){var j=d[i++];if(0===j)break;j-=1;var k,l=d[i++];if(2==l||3==l)for(k=0;j>k;k+=2)b.serviceUUIDs.push(c._canonicalUUID(f(d,i+k).toString(16)));else if(4==l||5==l)for(k=0;j>k;k+=4)b.serviceUUIDs.push(c._canonicalUUID(g(d,i+k).toString(16)));else if(6==l||7==l)for(k=0;j>k;k+=16)b.serviceUUIDs.push(c._canonicalUUID(h(d,i+k)));else 8!=l&&9!=l||(b.name=evothings.ble.fromUtf8(new Uint8Array(d.buffer,i,j)).replace("\x00",""));i+=j}return b}var j="00002902-0000-1000-8000-00805f9b34fb";if(b){var k=b.platformId;c._addAdapter("evothings",{deviceHandles:{},serviceHandles:{},characteristicHandles:{},descriptorHandles:{},notifyCallbacks:{},init:function(b,c){a.evothings&&evothings.ble?b():document.addEventListener("deviceready",b)},startScan:function(a,b,d){evothings.ble.startScan(function(d){var e=i(d),f=0===a.length||a.some(function(a){return e.serviceUUIDs.indexOf(a)>=0});if(f){var g=new c._Device(d.address,e.name,e.serviceUUIDs);b(g)}},d)},stopScan:function(a){evothings.ble.stopScan()},connect:function(a,b,c,d){evothings.ble.connect(a.address,function(d){0===d.state?(this.deviceHandles[a.address]&&(evothings.ble.close(this.deviceHandles[a.address]),delete this.deviceHandles[a.address]),c()):2===d.state&&(this.deviceHandles[a.address]=d.deviceHandle,b())}.bind(this),d)},disconnect:function(a,b){this.deviceHandles[a.address]&&evothings.ble.close(this.deviceHandles[a.address])},discoverServices:function(a,b,d,e){var f=this.deviceHandles[a.address];evothings.ble.services(f,function(e){e.forEach(function(d){if(0===b.length||b.indexOf(d.uuid)>=0){this.serviceHandles[d.handle]=f;var e=new c._Service(d.handle,d.uuid,0===d.type);a.services[e.uuid]=e}},this),d()}.bind(this),e)},discoverIncludedServices:function(a,b,c,d){c()},discoverCharacteristics:function(a,b,d,e){var f=this.serviceHandles[a._handle];evothings.ble.characteristics(f,a._handle,function(e){e.forEach(function(d){if(0===b.length||b.indexOf(d.uuid)>=0){this.characteristicHandles[d.handle]=f;var e=[],g=new c._Characteristic(d.handle,d.uuid,e);a.characteristics[g.uuid]=g}},this),d()}.bind(this),e)},discoverDescriptors:function(a,b,d,e){var f=this.characteristicHandles[a._handle];evothings.ble.descriptors(f,a._handle,function(e){e.forEach(function(d){if(0===b.length||b.indexOf(d.uuid)>=0){this.descriptorHandles[d.handle]=f;var e=new c._Descriptor(d.handle,d.uuid);a.descriptors[e.uuid]=e}},this),d()}.bind(this),e)},readCharacteristic:function(a,b,c){evothings.ble.readCharacteristic(this.characteristicHandles[a._handle],a._handle,function(d){"ios"===k&&this.notifyCallbacks[a.uuid]&&this.enableNotify(a,this.notifyCallbacks[a.uuid],null,c),b(d)}.bind(this),c)},writeCharacteristic:function(a,b,c,d){evothings.ble.writeCharacteristic(this.characteristicHandles[a._handle],a._handle,b,c,d)},enableNotify:function(a,b,c,d){var e=function(){evothings.ble.enableNotification(this.characteristicHandles[a._handle],a._handle,b,d),"ios"===k&&(this.notifyCallbacks[a.uuid]=b),c&&c()};if("android"===k){var f=a.descriptors[j];if(!f)return void d("cannot find notify descriptor");this.writeDescriptor(f,new Uint8Array([1,0]),e.bind(this),d)}else e.call(this)},disableNotify:function(a,b,c){evothings.ble.disableNotification(this.characteristicHandles[a._handle],a._handle,b,c),"ios"===k&&(delete this.notifyCallbacks[a.uuid],b())},readDescriptor:function(a,b,c){evothings.ble.readDescriptor(this.descriptorHandles[a._handle],a._handle,b,c)},writeDescriptor:function(a,b,c,d){evothings.ble.writeDescriptor(this.descriptorHandles[a._handle],a._handle,b,c,d)}})}}),/* @license
 *
 * BLE Abstraction Tool: noble adapter
 * Version: 0.0.5
 *
 * The MIT License (MIT)
 *
 * Copyright (c) 2016 Rob Moran
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */
function(a,b){"function"==typeof define&&define.amd?define(["noble","bleat","bluetooth.helpers"],b):"object"==typeof exports?module.exports=function(a){return b(require("noble"),a,require("./bluetooth.helpers"))}:b(a.noble,a.bleat,a.bleatHelpers)}(this,function(a,b,c){"use strict";function d(a,b){return function(c){if(c)a(c);else if("function"==typeof b){var d=[].slice.call(arguments,1);b.apply(this,d)}}}function e(a){var b=new Uint8Array(a).buffer;return new DataView(b)}function f(a){var b=new Uint8Array(a.buffer);return new Buffer(b)}a&&b._addAdapter("noble",{deviceHandles:{},serviceHandles:{},characteristicHandles:{},descriptorHandles:{},charNotifies:{},foundFn:null,initialised:!1,init:function(b,d){return this.initialised?b():(a.on("discover",function(a){if(this.foundFn){var b=a.address&&"unknown"!==a.address?a.address:a.id;this.deviceHandles[b]||(this.deviceHandles[b]=a);var d=[];a.advertisement.serviceUuids&&a.advertisement.serviceUuids.forEach(function(a){d.push(c.getCanonicalUUID(a))});var f={};if(a.advertisement.manufacturerData){var g=a.advertisement.manufacturerData.readUInt16LE(0);g=("0000"+g.toString(16)).slice(-4);var h=a.advertisement.manufacturerData.slice(2);f[g]=e(h)}var i={};a.advertisement.serviceData&&a.advertisement.serviceData.forEach(function(a){i[a.uuid]=e(a.data)}),this.foundFn({_handle:b,id:b,name:a.advertisement.localName,uuids:d,adData:{manufacturerData:f,serviceData:i,txPower:a.advertisement.txPowerLevel,rssi:a.rssi}})}}.bind(this)),this.initialised=!0,void b())},startScan:function(b,c,e,f){this.init(function(){this.deviceHandles={};var g=function(g){"poweredOn"===g?(0===b.length?this.foundFn=c:this.foundFn=function(a){b.forEach(function(b){return a.uuids.indexOf(b)>=0?void c(a):void 0})},a.startScanning([],!1,d(f,e))):f("adapter not enabled")}.bind(this);"unknown"===a.state?a.once("stateChange",g.bind(this)):g(a.state)}.bind(this),f)},stopScan:function(b){this.foundFn=null,a.stopScanning()},connect:function(a,b,c,e){var f=this.deviceHandles[a];f.once("connect",b),f.once("disconnect",function(){this.serviceHandles={},this.characteristicHandles={},this.descriptorHandles={},this.charNotifies={},c()}.bind(this)),f.connect(d(e))},disconnect:function(a,b){this.deviceHandles[a].disconnect(d(b))},discoverServices:function(a,b,e,f){var g=this.deviceHandles[a];g.discoverServices([],d(f,function(a){var d=[];a.forEach(function(a){var e=c.getCanonicalUUID(a.uuid);(0===b.length||b.indexOf(e)>=0)&&(this.serviceHandles[e]||(this.serviceHandles[e]=a),d.push({_handle:e,uuid:e,primary:!0}))},this),e(d)}.bind(this)))},discoverIncludedServices:function(a,b,e,f){var g=this.serviceHandles[a];g.discoverIncludedServices([],d(f,function(a){var d=[];a.forEach(function(a){var e=c.getCanonicalUUID(a.uuid);(0===b.length||b.indexOf(e)>=0)&&(this.serviceHandles[e]||(this.serviceHandles[e]=a),d.push({_handle:e,uuid:e,primary:!1}))},this),e(d)}.bind(this)))},discoverCharacteristics:function(a,b,f,g){var h=this.serviceHandles[a];h.discoverCharacteristics([],d(g,function(a){var d=[];a.forEach(function(a){var f=c.getCanonicalUUID(a.uuid);(0===b.length||b.indexOf(f)>=0)&&(this.characteristicHandles[f]||(this.characteristicHandles[f]=a),d.push({_handle:f,uuid:f,properties:{broadcast:a.properties.indexOf("broadcast")>=0,read:a.properties.indexOf("read")>=0,writeWithoutResponse:a.properties.indexOf("writeWithoutResponse")>=0,write:a.properties.indexOf("write")>=0,notify:a.properties.indexOf("notify")>=0,indicate:a.properties.indexOf("indicate")>=0,authenticatedSignedWrites:a.properties.indexOf("authenticatedSignedWrites")>=0,reliableWrite:a.properties.indexOf("reliableWrite")>=0,writableAuxiliaries:a.properties.indexOf("writableAuxiliaries")>=0}}),a.on("data",function(a,b){if(b===!0&&"function"==typeof this.charNotifies[f]){var c=e(a);this.charNotifies[f](c)}}.bind(this)))},this),f(d)}.bind(this)))},discoverDescriptors:function(a,b,e,f){var g=this.characteristicHandles[a];g.discoverDescriptors(d(f,function(a){var d=[];a.forEach(function(a){var e=c.getCanonicalUUID(a.uuid);if(0===b.length||b.indexOf(e)>=0){var f=g.uuid+"-"+a.uuid;this.descriptorHandles[f]||(this.descriptorHandles[f]=a),d.push({_handle:f,uuid:e})}},this),e(d)}.bind(this)))},readCharacteristic:function(a,b,c){this.characteristicHandles[a].read(d(c,function(a){var c=e(a);b(c)}))},writeCharacteristic:function(a,b,c,e){var g=f(b);this.characteristicHandles[a].write(g,!0,d(e,c))},enableNotify:function(a,b,c,e){return this.charNotifies[a]?(this.charNotifies[a]=b,c()):(this.characteristicHandles[a].once("notify",function(d){return d!==!0?e("notify failed to enable"):(this.charNotifies[a]=b,void c())}.bind(this)),void this.characteristicHandles[a].notify(!0,d(e)))},disableNotify:function(a,b,c){return this.charNotifies[characteristic.uuid]?(this.characteristicHandles[a].once("notify",function(d){return d!==!1?c("notify failed to disable"):(this.charNotifies[a]&&delete this.charNotifies[a],void b())}.bind(this)),void this.characteristicHandles[a].notify(!1,d(c))):b()},readDescriptor:function(a,b,c){this.descriptorHandles[a].readValue(d(c,function(a){var c=e(a);b(c)}))},writeDescriptor:function(a,b,c,e){var g=f(b);this.descriptorHandles[a].writeValue(g,d(e,c))}})});